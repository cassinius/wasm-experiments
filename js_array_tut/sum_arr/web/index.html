<!DOCTYPE html>
<html>

<body>
  <script src="gen/sum.js"></script>

  <script>

    function transferToHeap(floatArray) {

      // 1) Reserve memory on WASM heap
      heapSpace = Module._malloc(floatArray.length * floatArray.BYTES_PER_ELEMENT);

      Module.HEAPF32.set(floatArray, heapSpace >> 2); // 2 
      return heapSpace;
    }


    function sumUp(arr) {
      let arrayOnHeap;
      try {
        arrayOnHeap = transferToHeap(arr);
        return Module._sum_up(arrayOnHeap, arr.length);
      } 
      finally {
        Module._free(arrayOnHeap); // 5.
      }
    }


    Module.onRuntimeInitialized = function () {
      /**
       * 2e6 seems to be a good limit (3e6 gives OOM...)
       */
      const float_arr = new Float32Array([1, 2, 3, 4, 5, 6]);
      console.log(
        sumUp(float_arr)
      );
    }


    /**
     * Pure copy function (Array -> TypedArray)
     * 
     * @todo extend for nested arrays...
     * @todo try with 2D array && Floyd Warshal algorithm !
     */
    function toFloatArr(arr) {
      const res = new Float32Array(arr.length); // 3 
      for (let i = 0; i < arr.length; i++)
        res[i] = arr[i];
      return res;
    }

  </script>
</body>

</html>