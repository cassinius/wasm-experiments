<html>
  <body>
    <script src="gen/hello.js"></script>

    <script>
      // function loadWasm(fileName) {
      //   return fetch(fileName)
      //     .then(response => response.arrayBuffer())
      //     .then(bits => WebAssembly.compile(bits))
      //     .then(module => { return new WebAssembly.Instance(module ) });
      // }

      // loadWasm('gen/hello.wasm')
      //   .then(instance => {
      //     let fib_wasm = instance.exports.__Z3fibi;
      //     console.log(`fib_wasm(1) = ${fib_wasm(1)}`);
      //     console.log(`fib_wasm(20) = ${fib_wasm(20)}`);
      //     console.log(`fib_wasm(20) = ${fib_wasm(42)}`);
      //   });


      Module.onRuntimeInitialized = function() {
        let tic = new Date;

        console.log(`main() gives ${Module._main()}`);

        let fib1 = Module._new_fib();
        let fib2 = Module._new_fib();
        console.log(fib1);
        console.log(fib2);
        
        console.log(Module._next_val(fib1));
        console.log(Module._next_val(fib1));
        console.log(Module._next_val(fib1));
        console.log(Module._next_val(fib1));

        console.log(Module._next_val(fib2));
        console.log(Module._next_val(fib2));
        console.log(Module._next_val(fib2));
        console.log(Module._next_val(fib2));
        
        let toc = new Date;
        console.log(`Some fibs took ${toc-tic} ms in WASM`)
      }


      // function fib_js(x) {
      //   if (x < 1)
      //     return 0;
      //   if (x == 1)
      //     return 1;
      //   return fib_js(x-1) + fib_js(x-2);
      // }

      // async function initFib () {
      //   const fetchPromise = fetch('gen/hello.wasm');
      //   const module = await WebAssembly.compileStreaming(fetchPromise);
      //   const instance = await WebAssembly.instantiate(module);
      //   const fib = instance.exports.__Z3fibi;
      //   return fib;
      // }

      // (async () => {
      //   const fib_wasm = await initFib();
      //   console.log(fib_wasm);

      //   [{rt: fib_js, name: "JS"}, {rt: fib_wasm, name: "WASM"}].forEach(fib_rt => {
      //     let tic = new Date;
      //     // console.log(`fib_wasm(1) = ${fib_rt.rt(1)}`);
      //     // console.log(`fib_wasm(20) = ${fib_rt.rt(20)}`);
      //     console.log(`fib_wasm(42) = ${fib_rt.rt(42)}`);
      //     let toc = new Date;
      //     console.log(`Fib(42) took ${toc-tic} ms in ${fib_rt.name}`)
      //   });
      // })();


    </script>
  </body>
</html>
